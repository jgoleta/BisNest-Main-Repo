{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product | BisNest</title>
  <link rel="stylesheet" href="{% static 'css/productStyle.css' %}">
  <link rel="stylesheet" href="{% static 'css/centralDarkStyle.css' %}">
  <script src="{% static 'js/darkMode.js' %}"></script>
</head>

<body>
  <div class="bg-shape"></div>
  <input type="checkbox" id="sidebarToggle" style="display: none;">
  <label for="sidebarToggle" class="burger">
    <span></span>
    <span></span>
    <span></span>
  </label>
  <label for="sidebarToggle" class="overlay"></label>

  <nav class="navigation-top">
    <div class="navigation-div">
      <h1 class="page-name">Product Management</h1>

      <ul style="margin-left: 45%;">
        <li style="--i:#1e293b; --j:#414957;">
          <span class="icon">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"
              fill="#1e293b">
              <path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z" />
            </svg>
          </span>
          <span class="title">Home</span>
        </li>

        <li onclick="window.location.href='{% url 'about' %}'" style="--i:#1e293b; --j:#414957;">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#1e293b" class="bi bi-person-circle"
              viewBox="0 0 16 16">
              <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
              <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 
              4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
            </svg>
          </span>
          <span class="title">About</span>
        </li>

        <li style="--i:#1e293b; --j:#414957;">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#1e293b" class="bi bi-telephone-fill"
              viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.315 
              1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 
              .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 
              1.794c.829.645.905 1.87.163 2.611l-1.034 
              1.034c-.74.74-1.846 1.065-2.877.702a18.6 
              18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 
              1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z" />
            </svg>
          </span>
          <span class="title">Contact</span>
        </li>
      </ul>
    </div>
  </nav>

  <nav class="sidebar">
    <ul>
      <ul>
        <h1 class="web-name">BisNest</h1>
        <li><a href="{% url 'menu' %}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
              fill="currentColor" class="bi bi-bar-chart-fill" viewBox="0 0 16 16"
              style="vertical-align:middle;margin-right:8px">
              <path
                d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z" />
            </svg>Dashboard</a></li>
        <li><a href="{% url 'employeesinfo' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
              style="vertical-align:middle;margin-right:8px">
              <path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 2c-5 0-9 2.5-9 6v1h18v-1c0-3.5-4-6-9-6z" />
            </svg>Employee</a></li>
        <li><a href="{% url 'customer' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path
                d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zM8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5C23 14.17 18.33 13 16 13z" />
            </svg>Customer</a></li>
        <li><a href="{% url 'product' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M21 8l-9-5-9 5v8l9 5 9-5V8zM12 3v18" />
            </svg>Product</a></li>
        <li><a href="{% url 'history' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M7 3h10v4H7zM7 9h10v12H7zM9 11h6v2H9zM9 15h6v2H9z" />
            </svg>Order</a></li>
        <li><a href="{% url 'payment' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <rect x="2" y="5" width="20" height="14" rx="2" />
              <path d="M2 10h20" fill="#fff" />
            </svg>Payment</a></li>
        <li><a href="{% url 'delivery' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M3 7h13l4 4v6h-2a3 3 0 0 1-6 0H8a3 3 0 0 1-6 0V7zM16 8v4h3" />
            </svg>Delivery</a></li>
        <li><a href="{% url 'supply' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M21 16V8l-9-5-9 5v8l9 5 9-5z" />
            </svg>Supply</a></li>
        <li><a href="{% url 'sales' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <rect x="3" y="11" width="4" height="10" />
              <rect x="10" y="7" width="4" height="14" />
              <rect x="17" y="3" width="4" height="18" />
            </svg>Sales Report</a></li>
      </ul>
      <ul>
        <hr>
        <li><a href="{% url 'logout_view' %}" class="btn-signout"><svg class="signout-icon"
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" />
            </svg>Sign Out</a></li>
      </ul>
    </ul>
  </nav>

  <main class="main-content">
    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; gap: 10px;">
      <button id="add-product-btn" class="toggle-form-button">+ New</button>
    </div>
    <div id="product-list"
      style="display: flex; flex-direction: column; align-items: center; gap: 2rem; margin-top: 30px;">
      {% if products %}
      {% for product in products %}
      {% if forloop.counter0|divisibleby:6 %}
      <div style="display:flex; gap:2rem; margin-bottom:2rem;">
        {% endif %}

        <button class="product-button-style" data-id="{{ product.product_id }}" data-name="{{ product.name }}"
          data-price="{{ product.price }}" data-stock="{{ product.stock }}"
          data-image="{% if product.image %}{{ product.image.url }}{% endif %}">
          <img src="{% if product.image %}{{ product.image.url }}{% else %}{{ '' }}{% endif %}" class="parts-logo"
            alt="{{ product.name }}">
          <p class="product-price-label">₱{{ product.price|floatformat:2 }}</p>
          <p class="product-price-name">{{ product.name }}</p>
        </button>

        {% if forloop.counter0|add:1|divisibleby:6 or forloop.last %}
      </div>
      {% endif %}
      {% endfor %}
      {% else %}
      <p>No products available.</p>
      {% endif %}
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        <span class="close-add-modal close-button">&times;</span>
        <h2>Add Product</h2>
        <div class="modal-divider"></div>
        <form id="add-product-form" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div style="margin-bottom: 18px; text-align: left;">
            <label for="add-product-name">Product Name:</label>
            {{ form.name }}
          </div>
          <div style="margin-bottom: 18px; text-align: left;">
            <label for="add-product-stock">Stock:</label>
            {{ form.stock }}
          </div>
          <div style="margin-bottom: 18px; text-align: left;">
            <label for="add-product-price">Price (₱):</label>
            {{ form.price }}
          </div>
          <div style="margin-bottom: 18px; text-align: left;">
            <label for="add-product-image">Image:</label>
            {{ form.image }}
          </div>
          <button type="submit" class="submit-button"
            style="margin-top: 18px; min-width: 120px; font-size: 1.1rem; float: right;">Add</button>
        </form>
      </div>
    </div>

    <div id="product-modal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        <span class="close-button" id="close-edit-modal">&times;</span>
        <h2 id="modal-product-name">Product Name</h2>
        <div class="modal-divider"></div>
        <p><strong>ID:</strong> <span id="modal-product-id"></span></p>
        <div style="margin-bottom: 18px;">
          <label for="modal-product-name-input"><strong>Name:</strong></label>
          <input type="text" id="modal-product-name-input"
            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bbb;">
        </div>
        <div style="margin-bottom: 18px;">
          <label for="modal-product-stock"><strong>Stock:</strong></label>
          <input type="number" id="modal-product-stock" min="0"
            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bbb;">
        </div>
        <div style="margin-bottom: 18px;">
          <label for="modal-product-price"><strong>Price (₱):</strong></label>
          <input type="number" id="modal-product-price" min="0" step="0.01"
            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bbb;">
        </div>
        <div class="modal-actions">
          <button id="save-price-btn" class="submit-button">Save Changes</button>
          <button id="delete-modal-btn" class="delete-modal-btn">Delete</button>
        </div>
      </div>
    </div>
  </main>

  <div class="notification" id="notification"></div>

  <script>
    // Product grid is server-rendered. Attach click handlers to the rendered buttons.

    const addProductBtn = document.getElementById('add-product-btn');
    const addProductModal = document.getElementById('add-product-modal');
    const closeAddModal = document.querySelector('.close-add-modal');
    const addProductForm = document.getElementById('add-product-form');

    addProductBtn.addEventListener('click', () => {
      addProductModal.style.display = 'block';
    });
    closeAddModal.addEventListener('click', () => {
      addProductModal.style.display = 'none';
      addProductForm.reset();
    });
    window.addEventListener('click', (event) => {
      if (event.target === addProductModal) {
        addProductModal.style.display = 'none';
        addProductForm.reset();
      }
    });
    // Attach click handlers to server-rendered product buttons
    document.querySelectorAll('.product-button-style').forEach(btn => {
      btn.addEventListener('click', function (e) {
        document.querySelectorAll('.product-button-style.selected').forEach(el => el.classList.remove('selected'));
        btn.classList.add('selected');
        if (!e.target.classList.contains('delete-product-btn')) {
          const product = {
            id: btn.dataset.id,
            name: btn.dataset.name,
            price: btn.dataset.price,
            image: btn.dataset.image,
            stock: btn.dataset.stock
          };
          openEditModal(product, btn);
        }
      });
    });

    const modal = document.getElementById("product-modal");
    const productNameEl = document.getElementById("modal-product-name");
    const productIdEl = document.getElementById("modal-product-id");
    const productPriceEl = document.getElementById("modal-product-price");
    const closeEditModalBtn = document.getElementById("close-edit-modal");
    let currentButton = null;
    function openEditModal(product, btn) {
      productNameEl.textContent = product.name;
      modalNameInput.value = product.name;
      productIdEl.textContent = product.id;
      modalStockInput.value = btn.dataset.stock || '0';
      productPriceEl.value = product.price;
      modal.style.display = "block";
      currentButton = btn;
    }
    closeEditModalBtn.addEventListener('click', () => {
      modal.style.display = "none";
    });
    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });
    productPriceEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        saveBtn.click();
      }
    });
    const saveBtn = document.getElementById("save-price-btn");
    const modalNameInput = document.getElementById("modal-product-name-input");
    const modalStockInput = document.getElementById("modal-product-stock");

    // Read CSRF token from cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Save/update via AJAX to server endpoint
    saveBtn.addEventListener('click', () => {
      const newName = modalNameInput.value.trim();
      const newStock = modalStockInput.value.trim();
      const newPrice = productPriceEl.value.trim();

      if (!newName) {
        alert('Product name is required.');
        return;
      }
      if (!newStock || isNaN(newStock) || parseInt(newStock) < 0) {
        alert('Please enter a valid stock number (0 or greater).');
        return;
      }
      if (!newPrice || isNaN(newPrice) || parseFloat(newPrice) < 0) {
        alert('Please enter a valid price (0 or greater).');
        return;
      }

      const payload = {
        product_id: productIdEl.textContent,
        name: newName,
        stock: parseInt(newStock),
        price: parseFloat(newPrice).toFixed(2)
      };

      fetch('/product/update/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      }).then(res => res.json()).then(data => {
        if (data.success) {
          // update DOM: price label and name inside the selected button
          if (currentButton) {
            const priceLabel = currentButton.querySelector('.product-price-label');
            const nameLabel = currentButton.querySelector('.product-price-name');
            if (priceLabel) priceLabel.textContent = '₱' + parseFloat(data.price).toFixed(2);
            if (nameLabel) nameLabel.textContent = data.name;
            // Update button's data attributes
            currentButton.dataset.price = data.price;
            currentButton.dataset.name = data.name;
            currentButton.dataset.stock = data.stock;
          }
          showNotification('Product updated successfully!');
        } else {
          showNotification('Update failed: ' + (data.error || 'Unknown'), true);
        }
        modal.style.display = 'none';
      }).catch(err => {
        showNotification('Update failed: ' + err.message, true);
        modal.style.display = 'none';
      });
    });

    const deleteModalBtn = document.getElementById('delete-modal-btn');
    deleteModalBtn.addEventListener('click', () => {
      const productName = modalNameInput.value;
      if (!confirm(`Are you sure you want to delete "${productName}"? This cannot be undone.`)) {
        return;
      }

      const payload = { product_id: productIdEl.textContent };
      fetch('/product/delete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      }).then(res => res.json()).then(data => {
        if (data.success) {
          // remove from DOM - handle both button and its row wrapper if empty
          if (currentButton) {
            const row = currentButton.parentElement;
            currentButton.remove();
            // If this was the last product in the row, remove the row too
            if (row && row.children.length === 0) {
              row.remove();
            }
            // If no more products, show the "No products" message
            const productList = document.getElementById('product-list');
            if (productList && productList.querySelectorAll('.product-button-style').length === 0) {
              productList.innerHTML = '<p>No products available.</p>';
            }
          }
          showNotification('Product deleted successfully!');
        } else {
          showNotification('Delete failed: ' + (data.error || 'Unknown'), true);
        }
        modal.style.display = 'none';
      }).catch(err => {
        showNotification('Delete failed: ' + err.message, true);
        modal.style.display = 'none';
      });
    });

    function showNotification(message, error = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      if (error) {
        notification.classList.add('error');
      }
      setTimeout(() => {
        notification.classList.remove('show');
        notification.classList.remove('error');
      }, 3000);
    }
  </script>

</body>

</html>