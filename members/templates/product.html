{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product | BisNest</title>
    <link rel="stylesheet" href="{% static 'css/productStyle.css' %}">

</head>

<body>
  <div class="bg-shape"></div>
  <input type="checkbox" id="sidebarToggle" style="display: none;">
  <label for="sidebarToggle" class="burger">
    <span></span>
    <span></span>
    <span></span>
  </label>
  <label for="sidebarToggle" class="overlay"></label>

  <nav class="navigation-top">
    <div class="navigation-div">
      <h1 class="page-name">Product Management</h1>
      <ul style="margin-left: 45%;">
        <li><a style="color: #1e293b;" href="{% url 'about' %}">About</a></li>
        <li><a style="color: #1e293b;" href="#contact">Contact</a></li>
      </ul>
    </div>
  </nav>

  <nav class="sidebar">
    <ul>
      <ul>
        <h1 class="web-name">BisNest</h1>
        <li><a href="{% url 'menu' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z" />
            </svg>Home</a></li>
        <li><a href="{% url 'employeesinfo' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
              style="vertical-align:middle;margin-right:8px">
              <path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 2c-5 0-9 2.5-9 6v1h18v-1c0-3.5-4-6-9-6z" />
            </svg>Employee</a></li>
        <li><a href="{% url 'customer' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path
                d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zM8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5C23 14.17 18.33 13 16 13z" />
            </svg>Customer</a></li>
        <li><a href="{% url 'product' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M21 8l-9-5-9 5v8l9 5 9-5V8zM12 3v18" />
            </svg>Product</a></li>
        <li><a href="{% url 'history' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M7 3h10v4H7zM7 9h10v12H7zM9 11h6v2H9zM9 15h6v2H9z" />
            </svg>Order</a></li>
        <li><a href="{% url 'payment' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <rect x="2" y="5" width="20" height="14" rx="2" />
              <path d="M2 10h20" fill="#fff" />
            </svg>Payment</a></li>
        <li><a href="{% url 'delivery' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M3 7h13l4 4v6h-2a3 3 0 0 1-6 0H8a3 3 0 0 1-6 0V7zM16 8v4h3" />
            </svg>Delivery</a></li>
        <li><a href="{% url 'supply' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <path d="M21 16V8l-9-5-9 5v8l9 5 9-5z" />
            </svg>Supply</a></li>
        <li><a href="{% url 'sales' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:8px">
              <rect x="3" y="11" width="4" height="10" />
              <rect x="10" y="7" width="4" height="14" />
              <rect x="17" y="3" width="4" height="18" />
            </svg>Sales Report</a></li>
      </ul>
      <ul>
        <hr>
        <li><a href="{% url 'logout_view' %}" class="btn-signout"><svg class="signout-icon"
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" />
            </svg>Sign Out</a></li>
      </ul>
    </ul>
  </nav>

  <main class="main-content">
    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; gap: 10px;">
      <button id="add-product-btn" class="toggle-form-button">+ New</button>
    </div>
    <div id="product-list"
      style="display: flex; flex-direction: column; align-items: center; gap: 2rem; margin-top: 30px;">
      {% if products %}
        {% for product in products %}
          {% if forloop.counter0|divisibleby:6 %}
            <div style="display:flex; gap:2rem; margin-bottom:2rem;">
          {% endif %}

          <button class="product-button-style" data-id="{{ product.product_id }}" data-name="{{ product.name }}" data-price="{{ product.price }}" data-image="{% if product.image %}{{ product.image.url }}{% endif %}">
            <img src="{% if product.image %}{{ product.image.url }}{% else %}{{ '' }}{% endif %}" class="parts-logo" alt="{{ product.name }}">
            <p class="product-price-label">â‚±{{ product.price|floatformat:2 }}</p>
            <p class="product-price-name">{{ product.name }}</p>
          </button>

          {% if forloop.counter0|add:1|divisibleby:6 or forloop.last %}
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <p>No products available.</p>
      {% endif %}
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        <span class="close-add-modal close-button">&times;</span>
        <h2>Add Product</h2>
        <div class="modal-divider"></div>
        <form id="add-product-form" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div style="margin-bottom: 18px; text-align: left;">
            <label for="add-product-name">Product Name:</label>
            {{ form.name }}
          </div>
          <div style="margin-bottom: 18px; text-align: left;">
            <label for="add-product-stock">Stock:</label>
            {{ form.stock }}
          </div>
          <div style="margin-bottom: 18px; text-align: left;">
            <label for="add-product-price">Price (â‚±):</label>
            {{ form.price }}
          </div>
          <div style="margin-bottom: 18px; text-align: left;">
            <label for="add-product-image">Image:</label>
            {{ form.image }}
          </div>
          <button type="submit" class="submit-button"
            style="margin-top: 18px; min-width: 120px; font-size: 1.1rem; float: right;">Add</button>
        </form>
      </div>
    </div>

    <div id="edit-product-modal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        <span class="close-button" id="close-edit-modal">&times;</span>
        <h2>Edit Product</h2>
        <div class="modal-divider"></div>
        <form id="edit-product-form" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="edit-product-id" name="product_id">

          <div style="margin-bottom: 18px; text-align: left;">
            <label for="edit-product-name">Product Name:</label>
            <input type="text" id="edit-product-name" name="name" class="form-control" required>
          </div>

          <div style="margin-bottom: 18px; text-align: left;">
            <label for="edit-product-stock">Stock:</label>
            <input type="number" id="edit-product-stock" name="stock" class="form-control" min="0" required>
          </div>

          <div style="margin-bottom: 18px; text-align: left;">
            <label for="edit-product-price">Price (â‚±):</label>
            <input type="number" id="edit-product-price" name="price" class="form-control" step="0.01" required>
          </div>

          <div style="margin-bottom: 18px; text-align: left;">
            <label for="edit-product-image">Image:</label>
            <input type="file" id="edit-product-image" name="image" class="form-control-file" accept="image/*" onchange="previewEditImage(event)">
            <img id="edit-image-preview" src="#" alt="Image Preview"
                class="img-thumbnail mt-2"
                style="max-width: 200px; display: none;">
          </div>

          <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button type="submit" class="submit-button">Save</button>
            <button type="button" id="delete-modal-btn" class="delete-modal-btn">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <div class="notification" id="notification"></div>

    <script>
    // Product grid is server-rendered. Attach click handlers to the rendered buttons.

    const addProductBtn = document.getElementById('add-product-btn');
    const addProductModal = document.getElementById('add-product-modal');
    const closeAddModal = document.querySelector('.close-add-modal');
    const addProductForm = document.getElementById('add-product-form');

    addProductBtn.addEventListener('click', () => {
      addProductModal.style.display = 'block';
    });
    closeAddModal.addEventListener('click', () => {
      addProductModal.style.display = 'none';
      addProductForm.reset();
    });
    window.addEventListener('click', (event) => {
      if (event.target === addProductModal) {
        addProductModal.style.display = 'none';
        addProductForm.reset();
      }
    });
    // Attach click handlers to server-rendered product buttons
    document.querySelectorAll('.product-button-style').forEach(btn => {
      btn.addEventListener('click', function (e) {
        document.querySelectorAll('.product-button-style.selected').forEach(el => el.classList.remove('selected'));
        btn.classList.add('selected');
        if (!e.target.classList.contains('delete-product-btn')) {
          const product = {
            id: btn.dataset.id,
            name: btn.dataset.name,
            price: btn.dataset.price,
            image: btn.dataset.image,
            stock: btn.dataset.stock
          };
          openEditModal(product, btn);
        }
      });
    });

    const editModal = document.getElementById("edit-product-modal");
    const closeEditModalBtn = document.getElementById("close-edit-modal");
    const editForm = document.getElementById("edit-product-form");

    const editNameInput = document.getElementById("edit-product-name");
    const editStockInput = document.getElementById("edit-product-stock");
    const editPriceInput = document.getElementById("edit-product-price");
    const editImageInput = document.getElementById("edit-product-image");
    const editImagePreview = document.getElementById("edit-image-preview");
    const editProductIdInput = document.getElementById("edit-product-id");

    // ðŸ§© Open Edit Modal with Data from Clicked Product
    document.querySelectorAll('.product-button-style').forEach(btn => {
      btn.addEventListener('click', function (e) {
        // Mark as selected
        document.querySelectorAll('.product-button-style.selected').forEach(el => el.classList.remove('selected'));
        btn.classList.add('selected');

        // Populate form fields
        editProductIdInput.value = btn.dataset.id;
        editNameInput.value = btn.dataset.name;
        editPriceInput.value = btn.dataset.price;
        editStockInput.value = btn.dataset.stock || 0;

        // Show image preview (if available)
        if (btn.dataset.image) {
          editImagePreview.src = btn.dataset.image;
          editImagePreview.style.display = "block";
        } else {
          editImagePreview.style.display = "none";
        }

        // Open the modal
        editModal.style.display = "block";
      });
    });

    // ðŸ§© Close Modal Logic
    closeEditModalBtn.addEventListener('click', () => {
      editModal.style.display = "none";
    });

    window.addEventListener('click', (event) => {
      if (event.target === editModal) {
        editModal.style.display = "none";
      }
    });
    productPriceEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        saveBtn.click();
      }
    });
    const saveBtn = document.getElementById("save-price-btn");

    // Read CSRF token from cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Save/update via AJAX to server endpoint
    saveBtn.addEventListener('click', () => {
      const newPrice = productPriceEl.value.trim();
      if (!newPrice || isNaN(newPrice)) {
        alert('Please enter a valid numeric price.');
        return;
      }
      const payload = {
        product_id: productIdEl.textContent,
        price: parseFloat(newPrice).toFixed(2)
      };
      fetch('/product/update/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      }).then(res => res.json()).then(data => {
        if (data.success) {
          // update DOM: price label inside the selected button
          if (currentButton) {
            const priceLabel = currentButton.querySelector('.product-price-label');
            if (priceLabel) priceLabel.textContent = 'â‚±' + parseFloat(data.price).toFixed(2);
            // Also update its data-price attribute
            currentButton.dataset.price = data.price;
          }
          showNotification('Product updated successfully!');
        } else {
          showNotification('Update failed: ' + (data.error || 'Unknown'), true);
        }
        modal.style.display = 'none';
      }).catch(err => {
        showNotification('Update failed: ' + err.message, true);
        modal.style.display = 'none';
      });
    });

    const deleteModalBtn = document.getElementById('delete-modal-btn');
    deleteModalBtn.addEventListener('click', () => {
      const payload = { product_id: productIdEl.textContent };
      fetch('/product/delete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      }).then(res => res.json()).then(data => {
        if (data.success) {
          // remove from DOM
          if (currentButton && currentButton.parentElement) {
            currentButton.parentElement.removeChild(currentButton);
          }
          showNotification('Product deleted successfully!');
        } else {
          showNotification('Delete failed: ' + (data.error || 'Unknown'), true);
        }
        modal.style.display = 'none';
      }).catch(err => {
        showNotification('Delete failed: ' + err.message, true);
        modal.style.display = 'none';
      });
    });

    function showNotification(message, error = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      if (error) {
        notification.classList.add('error');
      }
      setTimeout(() => {
        notification.classList.remove('show');
        notification.classList.remove('error');
      }, 3000);
    }
    
function previewAddImage(event) {
  const input = event.target;
  const preview = document.getElementById('add-image-preview');
  if (input.files && input.files[0]) {
    const file = input.files[0];
    if (!file.type.startsWith('image/')) {
      alert('Please select a valid image file.');
      input.value = "";
      preview.style.display = 'none';
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    preview.style.display = 'none';
  }
}

function previewEditImage(event) {
  const input = event.target;
  const preview = document.getElementById('edit-image-preview');
  if (input.files && input.files[0]) {
    const file = input.files[0];
    if (!file.type.startsWith('image/')) {
      alert('Please select a valid image file.');
      input.value = "";
      preview.style.display = 'none';
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    preview.style.display = 'none';
  }
}

  </script>

</body>

</html>